define("app/parking/main",["../common/dialog","../common/utils/ajaxService","../common/message","../common/getBrowser","../common/utils/encodeHtml","./handlers/addDevice","./handlers/saveDevice"],function(e,t,i){var n=JOL.view.extend({type:"parking",template:"parking.main",events:{"contextmenu .listbox":"controlRclick","click [action=addDevice]":"addDevice","mouseleave #rightmenu ul":"hidemenu","click #park_device_list_userrows tr":"check","click .event_list_userrows tr":"checkEvent"},initialize:function(){var t=this,i=t.model.get("page"),n=JOL.model.extend({urlRoot:"/api/device/getList"}),s=e("../common/dialog");t.ajaxModel=new n,t.selectedDevice=null,t.ajaxService=e("../common/utils/ajaxService"),t.message=e("../common/message"),t.getBrowser=e("../common/getBrowser"),t.encodeHtml=e("../common/utils/encodeHtml"),t.addDevice=e("./handlers/addDevice"),t.addParking=new s({type:"parking",template:"parking._addparking",parent:t,width:600,events:{"click [name=btmSave]":e("./handlers/saveDevice")}}),t.deleteParking=new s({type:"parking",template:"parking._deletedlg",parent:t,width:600,events:{"click [name=btnYes]":"delDevice"},delDevice:function(){var e=JOL.model.extend({urlRoot:"./api/import/delDevice"}),t=this.model.get("deviceId"),n=this;(new e).save({deviceId:t,type:"parking"},{type:"post",success:function(e,t){var s=e.attributes.deviceId;return 200===t.code?(_.each(i.deviceList,function(e,t,i){e.deviceId===s&&i.splice(t,1)}),n.parent.render(),n.close(),void 0):(n.parent.message.open("add error","danger").show(),void 0)}})}}),t.hidemenu=function(e){var t=$(e.currentTarget);t.parent().css("display","none")},t.controlRclick=function(e){e.preventDefault();var i=$(e.currentTarget);i.data("ismainbox")&&t.$el.find("#rightmenu").css({display:"block",left:e.clientX-10+"px",top:e.clientY-70+"px"})},t.check=function(e){var i,n=$(e.currentTarget),s=t.model.get("page"),a=JOL.model.extend({urlRoot:"./api/device/getEventList"});return n.hasClass("selected")?(n.removeClass("selected"),t.selectedDevice=null,s.selectedDevice=null,void 0):(t.$el.find("#park_device_list_userrows tr").removeClass("selected"),n.addClass("selected"),i=n.attr("args"),_.each(s.deviceList,function(e){return""+e.deviceId===i?(t.selectedDevice=e,s.selectedDevice=e,void 0):void 0}),t.selectedDevice?(new a).save({type:"parking",deviceId:t.selectedDevice.deviceId},{type:"post",success:function(e,i){200===i.code?(s.eventList=i.list,t.$el.find(".parking-event-list").run("parking._eventlist",s),t.$el.find(".parking-device-info").run("parking._deviceinfo",s)):t.message.open("add error","danger").show()}}):(t.$el.find(".parking-event-list").run("parking._eventlist",s),t.$el.find(".parking-device-info").run("parking._deviceinfo",s)),void 0)},t.checkEvent=function(e){var i,n=$(e.currentTarget),s=t.model.get("page");return n.hasClass("selected")?(n.removeClass("selected"),t.selectedEvent=null,s.selectedEvent=null,void 0):(t.$el.find(".event_list_userrows tr").removeClass("selected"),n.addClass("selected"),i=n.attr("args"),_.each(s.eventList,function(e){return""+e.id===i?(t.selectedEvent=e,s.selectedEvent=e,t.$el.find(".image-template").run("parking._imageTemplate",s),void 0):void 0}),void 0)},t.ajaxModel=(new n).on("sync",function(e,n){return n.code&&200!==n.code?void 0:(i.deviceList=n.list,t.render(),!1)}),t.ajaxModel.fetch({type:"get",data:{type:"parking"},error:function(){return t.errordlg.open(),!1}})}});i.exports=new n}),define("app/common/dialog",[],function(e,t,i){var n,s=$(".dialog"),a=$(".dlg-wrapper"),o=Backbone.View.extend({el:".dlg-wrapper",constructor:function(e){this.initialize(e),this.undelegateEvents()},initialize:function(e){n=e,e.events=$.extend(e.events,o.prototype.events),$.extend(this,e),this.draggable=e.draggable===void 0?!0:e.draggable,this.overlay=e.overlay===void 0?!1:e.overlay,this.pos=e.pos===void 0?!1:e.pos,this.$el=$(this.el),this.$elp=$(this.elp),this.model=this.path?new JOL.model({page:pageModel[this.type][this.path]}):new JOL.model({page:pageModel[this.type]}),e.theme&&this.$el.addClass(e.theme),this.theme=e.theme,"function"==typeof e.init&&e.init.apply(this)},render:function(){var e=this;"function"==typeof this.beforerender?$.when(this.beforerender(e)).done(function(){e.$el.run(e.template,e.model.toJSON())}):this.$el.run(this.template,this.model.toJSON())},open:function(e,t){e&&"undefined"!==e.model&&(this.model=new JOL.model(e.model),e.model&&this.changeparam(e.model)),void 0!==this.theme?(this.$el.attr("class","dlg-wrapper hide "+this.theme),s.attr("class","dialog hide "+this.theme+"-o")):(this.$el.attr("class","dlg-wrapper hide "),e&&e.theme&&this.$el.attr("class","dlg-wrapper hide "+e.theme)&&s.attr("class","dialog hide "+e.theme+"-o"),this.model.get("theme")&&this.$el.attr("class","dlg-wrapper hide "+this.model.get("theme"))&&s.attr("class","dialog hide "+this.model.get("theme")+"-o")),this.render(),this.delegateEvents(),this.draggable||($(".dlg-wrapper").undelegate("mousedown"),$(window).unbind("scroll")),this.afterrender&&this.afterrender(),this._adjustPosition(t),this._addMoveListener(),s.show(),a.show(),e&&e.callback&&(this.callback=e.callback,this.execute&&e.callback())},changeparam:function(e){this.width=e.width?e.width:this.width,this.height=e.height?e.height:this.height,this.template=e.template?e.template:this.template},events:{"click .icon-close-blue":"close","click .cancelBtn":"close","click .doc-btn-can":"close","click .cancel":"close","click .closedlg":"close"}});o.prototype.close=function(){return this.undelegateEvents(),s.hide(),a.hide(),a.html(""),this.afterclose&&this.afterclose(),!1},o.prototype._adjustPosition=function(e){var t,i,n,o,r=$(window).width(),l=$(window).height(),d=$(window).scrollTop(),c=$("body").height();if(this.$el.height("auto"),t=this.$el.height(),(""+this.width).indexOf("%")>-1?(i=r*parseInt(this.width,10)/100,n=this.minWidth&&i>this.minWidth?.5*(r-i):.5*(r-this.minWidth)):n=.5*(r-this.width),o=t?.4*(l-t):.2*(l-t),t>l&&(o=40),this.pos){var h=$(e.target),p=h.offset();n=p.left,o=p.top+21,this.$el.find(".tab-container").css({height:t-20+"px"})}return s.css({width:r+"px",height:c+"px"}),this.overlay?(a.css({left:n+"px",top:o+d+"px"}),s.addClass("noticeoverlay")):(a.css({left:n+"px",top:o+d+"px"}),s.removeClass("noticeoverlay")),this.width&&(a.width(this.width),this.minWidth?a.css("min-width",this.minWidth+"px"):a.css("min-width","0px")),this},o.prototype._addMoveListener=function(){var e,t=this;if(this.pos||($(window).bind("scroll",function(){clearTimeout(e),e=setTimeout(function(){t._adjustPosition()},200)}),$(window).bind("resize",function(){clearTimeout(e),e=setTimeout(function(){t._adjustPosition()},200)})),this.draggable){var i,n,s,o,r,l,d,c,h;$(".dlg-wrapper").undelegate("mousedown").delegate(".dlg-header","mousedown",function(e){r=$(this).offset(),i=r.left,n=r.top,s=e.clientX,o=e.clientY,$("window,body").bind("mousemove",function(e){l=e.clientX-s,d=e.clientY-o,c=i+l,h=n+d,a.css("left",c+"px").css("top",h+"px")}).bind("mouseup",function(){$("window,body").unbind("mousemove")})})}return this},i.exports=o}),define("app/common/utils/ajaxService",[],function(e,t,i){i.exports=function(e,t,i,n){$.ajax({type:n?"post":"get",url:e,data:t,contentType:"application/json;charset=utf-8",success:function(e){if(e)try{i(JSON.parse(e))}catch(t){i(e)}},error:function(){}})}}),define("app/common/message",[],function(e,t,i){var n=JOL.view.extend({template:"common.message",events:{"click .close":"close"},initialize:function(){this.$el=$("body > .message"),this.visible=!1},open:function(e,t){return this.model=new JOL.model({message:e,type:t}),this.getBrowser=function(){function e(e){return l=i.exec(e),null!==l?{name:"IE",version:l[2]||"0"}:(l=n.exec(e),null!==l?{name:l[1]||"",version:l[2]||"0"}:(l=s.exec(e),null!==l?{name:l[1]||"",version:l[2]||"0"}:(l=a.exec(e),null!==l?{name:l[1]||"",version:l[2]||"0"}:(l=o.exec(e),null!==l?{name:l[2]||"",version:l[1]||"0"}:l?void 0:{name:"",version:"0"}))))}var t=navigator.userAgent,i=/(msie\s|trident.*rv:)([\w.]+)/,n=/(firefox)\/([\w.]+)/,s=/(opera).+version\/([\w.]+)/,a=/(chrome)\/([\w.]+)/,o=/version\/([\w.]+).*(safari)/,r=t.toLowerCase(),l="";return e(r)},this},scroll:function(){$("body > .message").css({top:$(window).scrollTop()})},close:function(){$(window).unbind("scroll",this.scroll),this.visible&&(this.$el.slideUp("slow"),this.visible=!1)},show:function(e,t){this.visible&&this.timeId&&clearTimeout(this.timeId);var i=this;this.render(),"6.0"===this.getBrowser().version&&(this.$el.css({position:"absolute",top:$(window).scrollTop()}),$(window).bind("scroll",this.scroll)),this.$el.slideDown("slow"),this.visible=!0,this.timeId=e?setTimeout(function(){i.close(t)},e):setTimeout(function(){i.close()},3e3)},afterRender:function(){}});i.exports=new n}),define("app/common/getBrowser",[],function(e,t,i){i.exports=function(){function e(e){return l=i.exec(e),null!==l?{name:"IE",version:l[2]||"0"}:(l=n.exec(e),null!==l?{name:l[1]||"",version:l[2]||"0"}:(l=s.exec(e),null!==l?{name:l[1]||"",version:l[2]||"0"}:(l=a.exec(e),null!==l?{name:l[1]||"",version:l[2]||"0"}:(l=o.exec(e),null!==l?{name:l[2]||"",version:l[1]||"0"}:null!==l?{name:"",version:"0"}:void 0))))}var t=navigator.userAgent,i=/(msie\s|trident.*rv:)([\w.]+)/,n=/(firefox)\/([\w.]+)/,s=/(opera).+version\/([\w.]+)/,a=/(chrome)\/([\w.]+)/,o=/version\/([\w.]+).*(safari)/,r=t.toLowerCase(),l="";return e(r)}}),define("app/common/utils/encodeHtml",[],function(e,t,i){var n={"<":"&lt;",">":"&gt;"};i.exports=function(e){return _.isArray(e)?(_.each(e,function(t,i){t=t.replace(/(<br[^>]*>)/g,"@_@"),t=t.replace(/[<>]/g,function(){e[i]=t}),e[i]=t.replace(/@_@/g,"<br />")}),e):(e=e.replace(/(<br[^>]*>)/g,"@_@"),e=e.replace(/[<>]/g,function(e){return n[e]}),e.replace(/@_@/g,"<br />"))}}),define("app/parking/handlers/addDevice",[],function(e,t,i){i.exports=function(e){var t=this,i=$(e.currentTarget).attr("args");return"add"===i?(t.addParking.open(),void 0):("edit"===i&&(t.selectedDevice?t.addParking.open({model:t.selectedDevice}):alert("未选中可编辑的设备")),"del"===i&&(t.selectedDevice?t.deleteParking.open({model:t.selectedDevice}):alert("未选中可删除的设备")),$(e.currentTarget).parents("#rightmenu").css("display","none"),void 0)}}),define("app/parking/handlers/saveDevice",[],function(e,t,i){i.exports=function(){var e,t=this,i=t.parent.model.get("page"),n=JOL.model.extend({urlRoot:"./api/import/addDevice"});return e={deviceCode:t.$el.find("[name=txtDevcieId]").val(),address:t.$el.find("[name=txtAddress]").val(),parkName:t.$el.find("[name=txtParkName]").val(),parkNum:t.$el.find("[name=TxtCarCount]").val(),note:t.$el.find("[name=txtNote]").val(),lon:t.$el.find("[name=txtLon]").val(),lat:t.$el.find("[name=txtLat]").val(),alt:t.$el.find("[name=txtAlt]").val(),floor:t.$el.find("[name=txtFloor]").val(),gisType:t.$el.find("[name=pmuAxisType]").val(),isHidden:t.$el.find("[name=chkMask]").prop("checked")?1:0,isCloudDevice:t.$el.find("[name=chkCloud]").prop("checked")?1:0,type:"parking"},t.model.get("deviceId")&&(n=JOL.model.extend({urlRoot:"./api/import/updateDevice"}),e.deviceId=t.model.get("deviceId")),(new n).save(e,{type:"post",success:function(n,s){if(200===s.code){if(e.deviceId)return _.each(i.deviceList,function(t){return t.deviceId===e.deviceId?($.extend(t,e),void 0):void 0}),t.parent.render(),t.close(),void 0;e.deviceId=s.result.deviceId,i.deviceList.push(e),t.parent.render(),t.close()}else t.parent.message.open("add error","danger").show()}}),t}});